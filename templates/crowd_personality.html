{% extends "base.html" %}
{% block title %}Crowd Personality Quiz{% endblock %}
{% block content %}

<h2>Crowd Personality Quiz</h2>

{% if not show_quiz %}
    <p class="text-danger">You must be <a href="/auth">logged in</a> to take this quiz.</p>
{% else %}
<div class="row">
    <!-- Left Column: Quiz Form -->
    <div class="col-md-6">
        <form method="POST">
            <label>1. I prefer to lead when moving through a crowd.</label><br>
            <input type="radio" name="q1" value="Agree" required> Agree<br>
            <input type="radio" name="q1" value="Neutral"> Neutral<br>
            <input type="radio" name="q1" value="Disagree"> Disagree<br><br>

            <label>2. I feel stressed when Iâ€™m surrounded by many people.</label><br>
            <input type="radio" name="q2" value="Agree" required> Agree<br>
            <input type="radio" name="q2" value="Neutral"> Neutral<br>
            <input type="radio" name="q2" value="Disagree"> Disagree<br><br>

            <label>3. I plan my route before entering a crowded area.</label><br>
            <input type="radio" name="q3" value="Agree" required> Agree<br>
            <input type="radio" name="q3" value="Neutral"> Neutral<br>
            <input type="radio" name="q3" value="Disagree"> Disagree<br><br>

            <label>4. I tend to follow others when unsure in a crowd.</label><br>
            <input type="radio" name="q4" value="Agree" required> Agree<br>
            <input type="radio" name="q4" value="Neutral"> Neutral<br>
            <input type="radio" name="q4" value="Disagree"> Disagree<br><br>

            <label>5. I avoid crowded places whenever I can.</label><br>
            <input type="radio" name="q5" value="Agree" required> Agree<br>
            <input type="radio" name="q5" value="Neutral"> Neutral<br>
            <input type="radio" name="q5" value="Disagree"> Disagree<br><br>

            <input type="submit" value="Submit" class="btn btn-primary">
        </form>

        {% if history %}
            <h5 class="mt-4">Your Past Quiz Results:</h5>
            <ul class="list-group">
                {% for row in history %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ row['result'] }}
                        <small class="text-muted">{{ row['timestamp'] }}</small>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <!-- Right Column: Donut Chart -->
    <div class="col-md-6">
        <h5 class="mb-3">Crowd Personality Distribution</h5>
        <div id="donut-chart" style="width: 100%; height: 400px;"></div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    fetch("/personality-data")
        .then(response => response.json())
        .then(data => {
            const labels = Object.keys(data);
            const values = Object.values(data);

            const chartData = [{
                type: "pie",
                hole: 0.4,
                labels: labels,
                values: values,
                textinfo: "label+percent",
                textposition: "outside"
            }];

            const layout = {
                title: "Live Crowd Personality Breakdown",
                showlegend: true,
                margin: { t: 50, b: 20, l: 20, r: 20 }
            };

            Plotly.newPlot("donut-chart", chartData, layout);
        });
});
</script>

{% endif %}

{% endblock %}
